# Story 1.2: PDF Processing Foundation

## Status
Completed

## Story
**As a** system,  
**I want** to handle both genuine and scanned PDF files,  
**So that** I can extract content regardless of PDF type.

## Acceptance Criteria
1. Prerequisites documented: Install poppler-utils for pdf2image functionality
2. Detect PDF type using pypdf, return 'genuine' or 'scanned' classification
3. For genuine PDFs: Extract text in format `{page: 1, text: "...", dimensions: {width: X, height: Y}}`
4. For scanned PDFs: Convert to PNG images at 300 DPI using pdf2image
5. Support page sizes: A0 (841×1189mm), A1 (594×841mm), and detect custom dimensions
6. Log PDF properties: `{type: "genuine|scanned", pages: N, dimensions: [...]}`
7. Error handling: Return specific errors for corrupted PDFs, password-protected files
8. Store extracted data in memory structure: `{pages: [{page_num: 1, content: ...}]}`

## Tasks / Subtasks
- [x] Create PDF processor utility module (AC: 2, 3, 4, 5)
  - [x] Create src/utils/pdf_processor.py with PDFProcessor class
  - [x] Implement PDF type detection method using pypdf
  - [x] Implement text extraction for genuine PDFs with page dimensions
  - [x] Implement image conversion for scanned PDFs using pdf2image
  - [x] Add page size detection and dimension calculations
- [x] Implement PDF metadata extraction (AC: 6)
  - [x] Create method to extract PDF properties (type, page count, dimensions)
  - [x] Add structured logging for PDF metadata using Python's logging module
  - [x] Ensure dimensions are captured for each page individually
- [x] Add comprehensive error handling (AC: 7)
  - [x] Handle corrupted PDF files with specific error messages
  - [x] Detect and handle password-protected PDFs
  - [x] Add graceful error handling for missing poppler-utils
  - [x] Return appropriate HTTP status codes for different error types
- [x] Update job model for PDF processing (AC: 8)
  - [x] Extend src/models/job.py with PDF processing fields
  - [x] Add metadata field for PDF properties
  - [x] Add processing_results field for extracted content structure
- [x] Update API to use PDF processor (AC: 1, 8)
  - [x] Integrate PDFProcessor into /process-drawing endpoint
  - [x] Store extracted content in job model
  - [x] Update API response to include PDF metadata
  - [x] Document poppler-utils requirement in README.md
- [x] Write comprehensive unit tests (Testing Requirements)
  - [x] Create tests/unit/test_utils/test_pdf_processor.py
  - [x] Test PDF type detection with various PDF samples
  - [x] Test text extraction with genuine PDFs
  - [x] Test image conversion with scanned PDFs
  - [x] Test error handling scenarios
  - [x] Add test fixtures in tests/fixtures/pdfs/
  - [x] Achieve 80% code coverage for pdf_processor module

## Dev Notes

### Previous Story Insights
From Story 1.1 implementation:
- Storage abstraction pattern established in src/storage/interface.py - use this for storing processed PDF data
- Job ID generation using timestamp format already implemented in src/utils/id_generator.py
- Already migrated from PyPDF2 to pypdf (v4.2.0) per QA recommendation in Story 1.1
- Consider path traversal protection when handling file operations

### PDF Processing Stack
[Source: architecture/tech-stack.md#core-technologies]
- **pypdf v4.2.0** - For text extraction from genuine PDFs (migrated from PyPDF2 in Story 1.1)
- **pdf2image v1.17.0** - Poppler wrapper for converting scanned PDFs
- **Pillow v10.2.0** - Image manipulation and processing
- **poppler-utils** - System dependency required for pdf2image

### Data Models
[Source: architecture/data-models.md#job-model]
The Job model needs to be extended with:
```python
metadata: {
    "file_name": str,
    "file_size_mb": float,
    "total_pages": int,
    "pdf_type": "scanned" | "genuine",
    "processing_time_seconds": int
}
```

### File Locations
Based on the source tree structure:
- PDF processor: `src/utils/pdf_processor.py` (new file)
- Update job model: `src/models/job.py` (existing)
- Update API routes: `src/api/routes.py` (existing)
- Test file: `tests/unit/test_utils/test_pdf_processor.py` (new)
- Test fixtures: `tests/fixtures/pdfs/` (new directory)

### Storage Patterns
[Source: architecture/database-schema.md]
For local development:
- Use existing local storage implementation from src/storage/local_storage.py
- Store processed PDF data in memory structure initially
- Future stories will persist to storage

### API Integration
[Source: architecture/rest-api-spec.md]
The /process-drawing endpoint response should be updated to include PDF metadata:
```json
{
    "job_id": "job_<timestamp>",
    "status": "processing",
    "metadata": {
        "pdf_type": "genuine|scanned",
        "total_pages": N,
        "file_size_mb": X.XX
    }
}
```

### Error Handling Requirements
[Source: architecture/coding-standards.md#error-handling]
- Use structured logging only (no print statements)
- Return specific error codes:
  - 400: Corrupted PDF or invalid format
  - 401: Password-protected PDF
  - 422: Missing required dependencies (poppler-utils)
  - 500: Unexpected processing errors

### Technical Constraints
[Source: architecture/backend-architecture.md#technical-constraints]
- Memory-efficient processing required for Lambda constraints
- Process pages individually if memory usage becomes an issue
- Maximum processing time: 10 minutes (Lambda timeout)

### Testing

**Testing Standards** [Source: architecture/test-strategy-and-standards.md]
- Test Framework: pytest 8.0.0
- Test file location: `tests/unit/test_utils/test_pdf_processor.py`
- Coverage requirement: 80% minimum for pdf_processor module
- Use AAA pattern (Arrange, Act, Assert)
- Mock external dependencies (pdf2image calls)
- Test fixtures location: `tests/fixtures/pdfs/`

**Critical Test Scenarios:**
1. Standard single-page drawing PDF
2. Multi-page PDF with mixed content
3. Scanned PDF requiring OCR
4. Corrupted PDF file
5. Password-protected PDF
6. Large PDF file (>50MB)
7. PDF with non-standard dimensions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-06 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-08-06 | 1.1 | Updated to use pypdf instead of PyPDF2 for consistency with Story 1.1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References
- Fixed linting errors identified by ruff
- Resolved type annotation issues for Python 3.11 compatibility
- Updated imports to avoid circular dependencies between api.models and models.job

### Completion Notes List
- PDF processor successfully handles both genuine and scanned PDFs
- Comprehensive error handling for corrupted, password-protected, and dependency issues
- API integration complete with metadata in response
- All tests written with mocked dependencies (pdf2image requires poppler-utils installation)
- Documentation updated with poppler-utils installation instructions
- All tests passing (17/17) with 93% code coverage on pdf_processor module

### File List
- Created: src/utils/pdf_processor.py
- Created: src/models/job.py
- Created: src/models/__init__.py
- Modified: src/api/routes.py
- Modified: src/api/models.py
- Modified: requirements.txt (added pdf2image==1.17.0 and Pillow==10.2.0)
- Modified: README.md (added poppler-utils installation instructions)
- Created: tests/unit/test_utils/test_pdf_processor.py
- Created: tests/fixtures/pdfs/README.md
- Created: tests/__init__.py
- Created: tests/unit/__init__.py
- Created: tests/unit/test_utils/__init__.py

## QA Results

### Review Date: 2025-08-06

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Overall, the implementation is solid and meets all acceptance criteria. The developer has successfully created a comprehensive PDF processing solution that handles both genuine and scanned PDFs effectively. The code demonstrates good understanding of the requirements and follows proper error handling patterns. I've performed several refactoring improvements to enhance the code quality further.

### Refactoring Performed

- **File**: src/api/routes.py
  - **Change**: Enhanced error handling to include job ID in log messages and save job status for all error cases
  - **Why**: Better debugging and traceability of failed jobs; consistent job status tracking
  - **How**: Added job ID to all error log messages, ensured job.mark_failed() and storage.save_job_status() are called for all exception types

- **File**: src/utils/pdf_processor.py
  - **Change**: Added memory-efficient batch processing for large PDFs
  - **Why**: Lambda has memory constraints; processing large PDFs could cause out-of-memory errors
  - **How**: Implemented batch processing in convert_scanned_pdf_to_images() to process pages in chunks of 50 (configurable)

- **File**: src/utils/pdf_processor.py
  - **Change**: Added dimension validation and standard size detection
  - **Why**: Improve data quality and provide useful logging for debugging
  - **How**: Added validation warnings for unusual dimensions and detect_standard_size() method to identify A0-A4 paper sizes

- **File**: tests/unit/test_utils/test_pdf_processor.py
  - **Change**: Fixed loop variable not used warning and updated tests for batch processing
  - **Why**: Clean code and ensure tests work with refactored batch processing logic
  - **How**: Changed unused loop variable to _, updated mocks to handle pypdf reader for page count

### Compliance Check

- Coding Standards: ✓ All code follows Python conventions, uses type hints, and has proper docstrings
- Project Structure: ✓ Files are correctly placed according to the unified project structure
- Testing Strategy: ✓ Comprehensive unit tests with 93% coverage, using pytest and AAA pattern
- All ACs Met: ✓ All 8 acceptance criteria are fully implemented and tested

### Improvements Checklist

[x] Enhanced error handling with better context and job tracking (src/api/routes.py)
[x] Implemented memory-efficient batch processing for large PDFs (src/utils/pdf_processor.py)
[x] Added dimension validation and standard size detection (src/utils/pdf_processor.py)
[x] Fixed all linting issues identified by ruff
[ ] Consider adding retry logic for transient PDF processing failures
[ ] Add metrics/monitoring for PDF processing performance
[ ] Consider implementing async PDF processing for better API responsiveness

### Security Review

No security concerns identified. The implementation properly:
- Validates file types before processing
- Uses temporary files that are cleaned up in finally blocks
- Doesn't expose internal error details to API responses
- Limits file size to prevent resource exhaustion

### Performance Considerations

- Batch processing implemented for memory efficiency with large PDFs
- Processing time is tracked and included in metadata
- Image conversion at 300 DPI provides good quality/size balance
- Consider implementing async processing for files >10MB to avoid blocking the API

### Final Status

✓ Approved - Ready for Done

All acceptance criteria have been met, tests are passing with excellent coverage (93%), and the code quality is high. The refactoring improvements enhance memory efficiency and error handling without changing the core functionality.