# Story 3.5: Serverless Deployment

## Status
Draft

## Story
**As a** developer,  
**I want** infrastructure as code and automated deployments,  
**so that** we can reliably deploy the serverless architecture.

## Acceptance Criteria
1. AWS SAM template defining all resources:
   - Lambda functions with environment configs
   - SQS queues with DLQ
   - DynamoDB table with indexes
   - API Gateway with stages
   - IAM roles with least privilege
2. GitHub Actions workflow:
   - On PR: sam validate and cfn-lint
   - On merge to develop: Deploy to staging
   - On merge to main: Deploy to production
3. Environment configurations:
   - Dev: Lower Lambda memory, shorter timeouts
   - Staging: Production-like with test data
   - Prod: Full resources, monitoring enabled
4. SAM deployment features:
   - Gradual deployment with CloudWatch alarms
   - Automatic rollback on errors
   - Parameter store for sensitive configs
5. Lambda layers for dependencies:
   - Common libraries in shared layer
   - Reduces deployment package size
   - Version controlled
6. Pre-traffic and post-traffic hooks for validation
7. Deployment notifications via SNS/Slack

## Tasks / Subtasks
- [ ] Enhance SAM Template (AC: 1, 4, 5)
  - [ ] Review existing `infrastructure/template.yaml` and identify gaps
  - [ ] Add missing resources (Lambda layers, deployment preferences)
  - [ ] Configure gradual deployment with CloudWatch alarms
  - [ ] Add pre-traffic and post-traffic hooks
  - [ ] Set up IAM roles with least privilege principles
  - [ ] Add parameter store integration for sensitive configs
- [ ] Create GitHub Actions Workflows (AC: 2)
  - [ ] Create `.github/workflows/validate.yml` for PR validation
  - [ ] Create `.github/workflows/deploy-staging.yml` for staging deployment
  - [ ] Create `.github/workflows/deploy-production.yml` for production deployment
  - [ ] Configure branch protection rules and merge conditions
- [ ] Configure Environment-Specific Parameters (AC: 3)
  - [ ] Update `infrastructure/samconfig.toml` with environment-specific settings
  - [ ] Create separate parameter files for dev/staging/prod
  - [ ] Configure Lambda memory and timeout per environment
  - [ ] Set up environment-specific monitoring levels
- [ ] Implement Lambda Layers (AC: 5)
  - [ ] Create shared dependencies layer definition
  - [ ] Update SAM template to include layer resource
  - [ ] Modify Lambda functions to reference shared layer
  - [ ] Create layer versioning strategy
- [ ] Set Up Deployment Notifications (AC: 7)
  - [ ] Add SNS topic resource to SAM template
  - [ ] Configure deployment notifications in GitHub Actions
  - [ ] Create optional Slack webhook integration
  - [ ] Add notification subscriptions for deployment events
- [ ] Implement Validation Hooks (AC: 6)
  - [ ] Create pre-traffic validation Lambda function
  - [ ] Create post-traffic validation Lambda function
  - [ ] Configure hooks in SAM deployment preferences
  - [ ] Add smoke test validations
- [ ] Create Deployment Documentation
  - [ ] Document deployment process and requirements
  - [ ] Create runbook for rollback procedures
  - [ ] Document environment promotion workflow
- [ ] Test Deployment Pipeline
  - [ ] Test GitHub Actions workflows with sample changes
  - [ ] Verify automatic rollback on failures
  - [ ] Test gradual deployment with traffic shifting
  - [ ] Validate notifications are sent correctly

## Dev Notes

### Previous Story Insights
From Story 3.3 (Serverless Monitoring):
- CloudWatch Log Groups already exist with 30-day retention
- Custom CloudWatch metrics utility created at `src/utils/cloudwatch_metrics.py`
- CloudWatch dashboards and health monitoring dashboards already implemented
- SNS alert topic (`AlertTopic`) already exists in SAM template for monitoring alerts
- X-Ray tracing enabled globally in SAM template

### Infrastructure Files [Source: architecture/source-tree.md]
- **SAM Template Location**: `infrastructure/template.yaml`
- **SAM Config**: `infrastructure/samconfig.toml`
- **Build Spec**: `infrastructure/buildspec.yml`
- **Existing Dashboards**: 
  - `infrastructure/cloudwatch-dashboard.json`
  - `infrastructure/health-monitoring-dashboard.json`
  - `infrastructure/cloudwatch-logs-insights-queries.json`

### Current SAM Template State [Source: infrastructure/template.yaml]
The template already includes:
- S3 Bucket with lifecycle rules and CORS configuration
- DynamoDB table with GSI indexes for status and client queries
- Processing Queue (SQS) reference
- Global Lambda configuration with X-Ray tracing enabled
- SNS Alert Topic for notifications
- Environment variables for Lambda functions

Missing from current template (needs to be added):
- Lambda function definitions
- API Gateway definition
- SQS Queue resource definition
- Dead Letter Queue (DLQ) configuration
- Lambda layers for shared dependencies
- Deployment preferences with CloudWatch alarms
- Pre/post traffic hooks

### Deployment Configuration [Source: architecture/infrastructure-and-deployment.md]
- **Tool**: AWS SAM 1.100+
- **Strategy**: Blue/Green deployment with automatic rollback
- **CI/CD Platform**: GitHub Actions
- **Rollback Triggers**:
  - Lambda error rate > 10%
  - API Gateway 5xx errors > 5%
  - DLQ messages present
- **Recovery Time Objective**: < 5 minutes (automatic rollback)

### Environment Naming Conventions [Source: architecture/infrastructure-and-deployment.md]
- **Development**: Local file system mode (no AWS resources)
- **Staging**: `security-assistant-staging-*`
- **Production**: `security-assistant-prod-*`

### GitHub Actions Workflow Structure [Source: architecture/infrastructure-and-deployment.md]
Deployment flow:
1. Development (Local) → git push
2. PR to develop branch → merge
3. Staging Deployment (automatic)
4. Manual approval required
5. PR to main branch → merge
6. Production Deployment (automatic)

### Technology Stack Requirements [Source: architecture/tech-stack.md]
- **Runtime**: Python 3.11 (strict requirement)
- **Lambda Runtime**: Python 3.11
- **Deployment Tool**: AWS SAM 1.100+
- **CI/CD**: GitHub Actions
- **Monitoring**: CloudWatch (already configured)
- **Queue Service**: AWS SQS with DLQ support
- **IaC Location**: `infrastructure/template.yaml`

### Lambda Function Requirements
Lambda functions should have (based on existing global config):
- Runtime: python3.11
- MemorySize: 1024 MB (adjustable per environment)
- Timeout: 900 seconds (adjustable per environment)
- Tracing: Active (X-Ray)
- Environment variables for AWS service references

### Testing
**Testing Standards from Architecture** [Source: architecture/test-strategy-and-standards.md]
- **CI Integration Requirements**:
  - Unit/Integration tests on every commit
  - Tests must pass before deployment
  - Use pytest framework (version 8.0.0)
  
**GitHub Actions Testing Requirements**:
- PR validation should run:
  - `sam validate` to check template syntax
  - `cfn-lint` for CloudFormation best practices
  - Python unit tests with pytest
  - Coverage checks (80% minimum)

**Deployment Testing**:
- Pre-traffic hooks should validate:
  - Lambda function health
  - Database connectivity
  - S3 bucket access
  - SQS queue availability
- Post-traffic hooks should validate:
  - Error rate thresholds
  - Response time metrics
  - Successful processing of test job

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-10 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_